<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lucky Wheel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- CSP laxa para permitir WebSocket locales (ajústala si tu entorno ya define CSP propia) -->
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' data: blob:; img-src * data: blob:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval' https: http:; connect-src * ws: wss:;">

  <style>
    body{font-family:'Poppins',sans-serif;background-color:transparent;color:#e0e0e0;overflow:hidden}
    .screen{display:none;position:absolute;inset:0;width:100%;height:100vh;justify-content:center;align-items:center;flex-direction:column;padding:1rem;box-sizing:border-box;transition:opacity .3s ease}
    .screen.active{display:flex}
    .btn{padding:.75rem 2rem;border-radius:.5rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;transition:all .2s ease;box-shadow:0 4px 6px rgba(0,0,0,.2);cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background-color:#4f46e5;color:#fff}
    .btn-primary:hover:not(:disabled){background-color:#4338ca}
    .btn-secondary{background-color:#374151;color:#fff}
    .btn-secondary:hover{background-color:#4b5563}
    .btn-green{background:linear-gradient(180deg,#4ade80,#22c55e);color:#1e293b;border:1px solid #86efac}
    .btn-green:hover{background:linear-gradient(180deg,#86efac,#4ade80)}
    .modal-bg{background-color:rgba(26,26,46,.85)}
    .lucky-wheel-logo{filter:drop-shadow(0 0 1rem rgba(139,92,246,.6))}
    .roulette-container{width:100%;max-width:90vw;height:120px;background:rgba(0,0,0,.2);border-radius:1rem;position:relative;overflow:hidden;border:3px solid #4f46e5;box-shadow:0 0 20px rgba(79,70,229,.5)}
    .roulette-pointer{position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:15px solid transparent;border-right:15px solid transparent;border-top:20px solid #facc15;z-index:10}
    .roulette-wheel{position:absolute;top:0;left:0;height:100%;display:flex;will-change:transform;transition:transform 7s cubic-bezier(.25,.1,.25,1)}
    .roulette-item{width:120px;height:120px;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:1.1rem;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.5);flex-shrink:0;padding:5px;text-align:center;box-sizing:border-box;border-right:1px solid rgba(255,255,255,.1)}
    .winner-modal{animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    .status-indicator{padding:.5rem 1rem;border-radius:9999px;font-size:.875rem;font-weight:600;display:inline-flex;align-items:center}
    .status-indicator .dot{width:.75rem;height:.75rem;border-radius:50%;margin-right:.5rem;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body>
  <div id="homeScreen" class="screen">
    <div class="absolute top-4 right-4">
      <div id="connectionStatus" class="status-indicator bg-gray-700 text-gray-300">
        <span class="dot bg-gray-500"></span>
        <span>Desconectado</span>
      </div>
    </div>
    <div class="text-center">
      <svg class="lucky-wheel-logo w-48 h-48 mx-auto mb-8" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#a78bfa;stop-opacity:1"/>
            <stop offset="100%" style="stop-color:#4f46e5;stop-opacity:1"/>
          </linearGradient>
          <linearGradient id="textGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#fde047;stop-opacity:1"/>
            <stop offset="100%" style="stop-color:#fbbf24;stop-opacity:1"/>
          </linearGradient>
        </defs>
        <circle cx="50" cy="50" r="48" fill="url(#logoGradient)" stroke="#c4b5fd" stroke-width="4"/>
        <text x="50" y="58" font-family="Poppins, sans-serif" font-size="20" font-weight="bold" fill="url(#textGradient)" text-anchor="middle">LUCKY</text>
        <text x="50" y="78" font-family="Poppins, sans-serif" font-size="20" font-weight="bold" fill="url(#textGradient)" text-anchor="middle">WHEEL</text>
      </svg>
      <h1 class="text-4xl font-bold mb-10">Ruleta de la Suerte</h1>
      <div class="space-y-4">
        <button id="playBtn" class="btn btn-primary w-48">Jugar Manual</button>
        <button id="settingsBtn" class="btn btn-secondary w-48">Ajustes</button>
      </div>
    </div>
  </div>

  <div id="settingsScreen" class="screen modal-bg">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
      <h2 class="text-3xl font-bold mb-6">Ajustes</h2>
      <button id="newWheelBtn" class="btn btn-primary w-full mb-4">Crear/Editar Ruleta</button>
      <button id="backToHomeFromSettingsBtn" class="btn btn-secondary w-full">Volver</button>
    </div>
  </div>

  <div id="createWheelScreen" class="screen modal-bg">
    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-2xl h-full max-h-[90vh] flex flex-col">
      <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Crear Ruleta</h2>
      <div id="optionsContainer" class="space-y-3 overflow-y-auto p-2 flex-grow"></div>
      <div class="mt-4 space-x-2 flex-shrink-0">
        <button id="addOptionBtn" class="btn btn-primary">Añadir Opción</button>
        <button id="saveWheelBtn" class="btn btn-green">Guardar y Obtener Enlace</button>
        <button id="backToSettingsBtn" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="playScreen" class="screen">
    <div id="setupMessage" class="hidden text-center p-8 bg-gray-800 rounded-lg shadow-xl max-w-lg">
      <p class="text-2xl font-bold text-yellow-400 mb-4">¡La ruleta está vacía!</p>
      <p class="text-lg">Para empezar, abre tu enlace y añade <strong class="text-white">?setup=true</strong> a la URL para configurar las opciones.</p>
    </div>

    <div id="gameUI" class="w-full flex flex-col items-center">
      <div class="absolute top-4 left-4">
        <button id="backToHomeFromPlayBtn" class="btn btn-secondary">Volver al Inicio</button>
      </div>
      <div class="text-center mb-6">
        <p class="text-xl">Giro por:</p>
        <p id="donorNameDisplay" class="text-3xl font-bold text-yellow-400"></p>
      </div>
      <div class="roulette-container">
        <div class="roulette-pointer"></div>
        <div id="rouletteWheel" class="roulette-wheel"></div>
      </div>
      <button id="spinBtn" class="btn btn-primary mt-8 text-2xl px-12 py-4">¡Girar!</button>
    </div>
  </div>

  <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center hidden winner-modal">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center">
      <p id="spinTriggerText" class="text-lg mb-2"></p>
      <h2 class="text-xl mb-4">El ganador es:</h2>
      <p id="winnerResult" class="text-4xl font-bold mb-6"></p>
      <button id="closeWinnerModalBtn" class="btn btn-primary">Cerrar</button>
    </div>
  </div>

  <div id="linkModal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center hidden winner-modal">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-lg text-left">
      <h2 id="linkModalTitle" class="text-2xl font-bold mb-4">¡Ruleta Guardada y Lista!</h2>
      <p id="linkModalDescription" class="mb-4">Usa este enlace único en TikTok Studio. Ya tiene tus opciones configuradas:</p>
      <textarea id="linkModalTextarea" class="w-full h-24 bg-gray-900 text-white p-2 rounded border border-gray-600 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
      <div class="mt-4 flex justify-end space-x-2">
        <button id="copyLinkBtn" class="btn btn-primary">Copiar Enlace</button>
        <button id="closeLinkModalBtn" class="btn btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center hidden winner-modal">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-center max-w-sm">
      <p id="alertMessage" class="text-lg mb-6"></p>
      <button id="closeAlertModalBtn" class="btn btn-primary">Aceptar</button>
    </div>
  </div>

  <script>
    const screens = {
      home: document.getElementById('homeScreen'),
      settings: document.getElementById('settingsScreen'),
      createWheel: document.getElementById('createWheelScreen'),
      play: document.getElementById('playScreen')
    };

    const buttons = {
      play: document.getElementById('playBtn'),
      settings: document.getElementById('settingsBtn'),
      newWheel: document.getElementById('newWheelBtn'),
      backToHomeFromSettings: document.getElementById('backToHomeFromSettingsBtn'),
      addOption: document.getElementById('addOptionBtn'),
      saveWheel: document.getElementById('saveWheelBtn'),
      backToSettings: document.getElementById('backToSettingsBtn'),
      backToHomeFromPlay: document.getElementById('backToHomeFromPlayBtn'),
      spin: document.getElementById('spinBtn'),
      closeWinnerModal: document.getElementById('closeWinnerModalBtn')
    };

    const optionsContainer = document.getElementById('optionsContainer');
    const rouletteWheel = document.getElementById('rouletteWheel');
    const winnerModal = document.getElementById('winnerModal');
    const winnerResult = document.getElementById('winnerResult');
    const donorNameDisplay = document.getElementById('donorNameDisplay');
    const spinTriggerText = document.getElementById('spinTriggerText');
    const connectionStatus = document.getElementById('connectionStatus');

    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeAlertModalBtn = document.getElementById('closeAlertModalBtn');
    const linkModal = document.getElementById('linkModal');
    const linkModalTextarea = document.getElementById('linkModalTextarea');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const closeLinkModalBtn = document.getElementById('closeLinkModalBtn');

    let currentWheelOptions = [];
    let isSpinning = false;
    let isSetupMode = false;

    function showAlert(message){ alertMessage.textContent = message; alertModal.style.display = 'flex'; }
    closeAlertModalBtn.addEventListener('click',()=>{ alertModal.style.display='none'; });
    copyLinkBtn.addEventListener('click',()=>{ linkModalTextarea.select(); document.execCommand('copy'); showAlert('¡Enlace copiado al portapapeles!'); });
    closeLinkModalBtn.addEventListener('click',()=>{ linkModal.style.display='none'; showScreen('settings'); });

    function showScreen(name){
      Object.values(screens).forEach(s=>s.classList.remove('active'));
      screens[name].classList.add('active');
    }

    buttons.settings.addEventListener('click',()=>showScreen('settings'));
    buttons.newWheel.addEventListener('click',()=>{ populateCreateScreen(); showScreen('createWheel'); });
    buttons.backToHomeFromSettings.addEventListener('click',()=>showScreen('home'));
    buttons.backToSettings.addEventListener('click',()=>showScreen('settings'));
    buttons.backToHomeFromPlay.addEventListener('click',()=>showScreen('home'));
    buttons.play.addEventListener('click',()=>{
      if(currentWheelOptions.length>0){ triggerSpin('Juego Manual'); }
      else{ showAlert('Primero debes crear una ruleta en Ajustes.'); }
    });

    let optionIdCounter=0;
    const colorPalette = ["#ef4444","#f97316","#eab308","#84cc16","#22c55e","#14b8a6","#06b6d4","#3b82f6","#8b5cf6","#d946ef"];
    function getNextColor(){
      const used = Array.from(optionsContainer.querySelectorAll('input[type="color"]')).map(i=>i.value);
      return colorPalette.find(c=>!used.includes(c)) || colorPalette[Math.floor(Math.random()*colorPalette.length)];
    }
    function createOptionElement({text='',frequency=1,color}){
      optionIdCounter++; const id=`option-${optionIdCounter}`; const newColor=color||getNextColor();
      const div=document.createElement('div');
      div.id=id; div.className='flex items-center space-x-2 bg-gray-700 p-2 rounded';
      div.innerHTML=`
        <input type="text" value="${text}" placeholder="Texto de la opción" class="text-input flex-grow bg-gray-600 rounded p-2 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
        <input type="number" value="${frequency}" min="1" class="freq-input w-20 bg-gray-600 rounded p-2 border border-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
        <input type="color" value="${newColor}" class="color-input w-10 h-10 p-1 bg-gray-600 rounded border border-gray-500 cursor-pointer">
        <button class="remove-option-btn bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded">&times;</button>
      `;
      optionsContainer.appendChild(div);
      div.querySelector('.remove-option-btn').addEventListener('click',()=>div.remove());
    }
    function populateCreateScreen(){
      optionsContainer.innerHTML=''; 
      if(currentWheelOptions.length>0){ currentWheelOptions.forEach(o=>createOptionElement(o)); }
      else{ createOptionElement({}); createOptionElement({}); }
    }
    buttons.addOption.addEventListener('click',()=>createOptionElement({}));
    buttons.saveWheel.addEventListener('click',()=>{
      const options=[]; const els=optionsContainer.querySelectorAll('.flex.items-center');
      let hasError=false;
      els.forEach(el=>{
        const text=el.querySelector('.text-input').value.trim();
        const frequency=parseInt(el.querySelector('.freq-input').value,10);
        const color=el.querySelector('.color-input').value;
        if(!text || isNaN(frequency) || frequency<1){ hasError=true; }
        options.push({text,frequency,color});
      });
      if(hasError){ showAlert('Completa todos los campos y asegúrate que la frecuencia sea al menos 1.'); return; }
      if(options.length<2){ showAlert('Necesitas al menos 2 opciones.'); return; }
      currentWheelOptions=options; saveWheelToLocalStorage(); prepareRoulette();
      const base64=btoa(JSON.stringify(currentWheelOptions));
      const baseURL=window.location.origin+window.location.pathname;
      const link=`${baseURL}?wheel=${base64}`;
      linkModalTextarea.value=link; linkModal.style.display='flex';
    });

    function saveWheelToLocalStorage(){ localStorage.setItem('luckyWheelOptions', JSON.stringify(currentWheelOptions)); }
    function loadWheelFromLocalStorage(){
      const saved=localStorage.getItem('luckyWheelOptions');
      if(saved && saved!=='[]'){ currentWheelOptions=JSON.parse(saved); prepareRoulette(); buttons.play.disabled=false; return true; }
      buttons.play.disabled=true; currentWheelOptions=[]; prepareRoulette(); return false;
    }

    function prepareRoulette(){
      rouletteWheel.innerHTML='';
      if(currentWheelOptions.length===0) return;
      let weighted=[];
      currentWheelOptions.forEach(o=>{ for(let i=0;i<o.frequency;i++){ weighted.push(o);} });
      for(let i=weighted.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [weighted[i],weighted[j]]=[weighted[j],weighted[i]]; }
      const wheelItems=[...weighted,...weighted,...weighted];
      wheelItems.forEach(item=>{
        const el=document.createElement('div');
        el.className='roulette-item';
        el.textContent=item.text; el.style.backgroundColor=item.color;
        rouletteWheel.appendChild(el);
      });
    }

    function triggerSpin(donor='Juego Manual'){
      if(isSpinning || currentWheelOptions.length<2) return;
      isSpinning=true; showScreen('play');
      donorNameDisplay.textContent=donor; spinTriggerText.textContent=`Giro por ${donor}`;
      document.getElementById('spinBtn').style.display=(donor==='Juego Manual' && isSetupMode)?'block':'none';
      const totalItems=rouletteWheel.children.length;
      const section=totalItems/3; const itemWidth=120;
      const winnerIndexInSection=Math.floor(Math.random()*section);
      const targetIndex=section + winnerIndexInSection;
      const randomOffset=(Math.random()-0.5)*itemWidth*0.8;
      const targetPos=(targetIndex*itemWidth)-(rouletteWheel.parentElement.clientWidth/2)+(itemWidth/2)+randomOffset;
      rouletteWheel.style.transition='none'; rouletteWheel.style.transform='translateX(0px)';
      setTimeout(()=>{ rouletteWheel.style.transition='transform 7s cubic-bezier(0.25,0.1,0.25,1)'; rouletteWheel.style.transform=`translateX(-${targetPos}px)`; },50);
      rouletteWheel.addEventListener('transitionend',()=>{
        isSpinning=false;
        const winner=rouletteWheel.children[targetIndex];
        winnerResult.textContent=winner.textContent;
        winnerResult.style.color=winner.style.backgroundColor;
        winnerModal.style.display='flex';
      },{once:true});
    }

    buttons.closeWinnerModal.addEventListener('click',()=>{
      winnerModal.style.display='none';
      prepareRoulette(); rouletteWheel.style.transition='none'; rouletteWheel.style.transform='translateX(0px)';
      if(isSetupMode){ showScreen('home'); } else { donorNameDisplay.textContent='Esperando donación...'; }
    });

    /* ======================
       WEBSOCKET ROBUSTO
       ====================== */
    const WS_ENDPOINTS = [
      'ws://192.168.1.69:21212/'
    ];
    let ws=null, wsIndex=0;

    function setConnectedUI(ok){
      if(ok){
        connectionStatus.innerHTML = `<span class="dot bg-green-500"></span><span>Conectado</span>`;
        connectionStatus.classList.remove('bg-gray-700','text-gray-300');
        connectionStatus.classList.remove('bg-red-800','text-red-200');
        connectionStatus.classList.add('bg-green-800','text-green-200');
      }else{
        connectionStatus.innerHTML = `<span class="dot bg-red-500"></span><span>Reconectando...</span>`;
        connectionStatus.classList.remove('bg-green-800','text-green-200');
        connectionStatus.classList.add('bg-red-800','text-red-200');
      }
    }

    function nextAttempt(){ wsIndex=(wsIndex+1)%WS_ENDPOINTS.length; setConnectedUI(false); setTimeout(connectWebSocket, 3000); }

    function connectWebSocket(){
      const url = WS_ENDPOINTS[wsIndex];
      try{
        ws = new WebSocket(url);
      }catch(e){
        console.error('Fallo creando WebSocket', e);
        return nextAttempt();
      }

      ws.onopen = ()=>{
        console.log('Conectado a TikFinity en', url);
        setConnectedUI(true);
      };

      ws.onmessage = (event)=>{
        // --- Parser tolerante ---
        let msgRaw = event.data;
        let msg;
        try{
          msg = typeof msgRaw === 'string' ? JSON.parse(msgRaw) : msgRaw;
        }catch(err){
          console.warn('Mensaje no-JSON:', msgRaw);
          return;
        }

        const evtName = String((msg.event || msg.type || msg.name || '')).toLowerCase();
        const data = msg.data || msg.payload || msg;
        if(!data) return;

        const user = data.user || data.username || data.nickname || data.displayName || 'Anónimo';

        // Extrae coins/diamonds de múltiples claves posibles
        const coinKeys = ['coins','coin','coinCount','diamondCount','diamonds','amount','value'];
        let donationValue = 0;
        for(const k of coinKeys){
          if(data[k] != null && !isNaN(Number(data[k]))){ donationValue = Number(data[k]); break; }
        }

        const giftName = data.giftName || (data.gift && (data.gift.name || data.gift.giftName)) || '';
        const isRose = /rose|rosa/i.test(String(giftName));

        const isGiftEvt = evtName.includes('gift') || !!giftName || data.giftId != null;

        // Manejo de streaks: si existen flags de fin de combo, espera al final
        const hasStreakFlags = Object.prototype.hasOwnProperty.call(data, 'repeatCount') || Object.prototype.hasOwnProperty.call(data, 'repeatEnd');
        const isStreakFinal = (data.repeatEnd === true) || (data.final === true) || (data.is_final === true) || (data.streakEnded === true);

        if(isGiftEvt){
          // Condición: Rose o >= 1 coin (cubre "moneda" y combos de rosas)
          const shouldSpin = isRose || donationValue >= 1;
          if(shouldSpin){
            if(hasStreakFlags && !isStreakFinal){
              console.log('Gift en streak, esperando fin…', {user, giftName, donationValue, repeatCount:data.repeatCount});
              return;
            }
            console.log(`Trigger por regalo: ${user} | gift="${giftName}" | coins=${donationValue}`);
            triggerSpin(user);
          }else{
            console.log('Regalo ignorado por filtro', {evtName, giftName, donationValue});
          }
        }
      };

      ws.onclose = ()=>{
        console.log('Desconectado de TikFinity. Reintentando…');
        nextAttempt();
      };

      ws.onerror = (err)=>{
        console.error('Error de WebSocket:', err);
        try{ ws.close(); }catch(_){}
      };
    }

    function initializeApp(){
      const urlParams=new URLSearchParams(window.location.search);
      isSetupMode = urlParams.has('setup');
      let optionsLoaded=false;

      if(urlParams.has('wheel')){
        const base64=urlParams.get('wheel');
        try{
          const json=atob(base64);
          const imported=JSON.parse(json);
          if(Array.isArray(imported) && imported.length>0){
            currentWheelOptions=imported; saveWheelToLocalStorage(); prepareRoulette(); buttons.play.disabled=false; optionsLoaded=true;
          }
        }catch(e){ console.error('Error decodificando ruleta desde URL:', e); }
      }

      if(!optionsLoaded){ optionsLoaded = loadWheelFromLocalStorage(); }

      if(isSetupMode){
        document.body.style.backgroundColor='#1a1a2e'; showScreen('home');
      }else{
        document.body.style.backgroundColor='transparent';
        const gameUI=document.getElementById('gameUI'); const setupMessage=document.getElementById('setupMessage');
        if(optionsLoaded){ gameUI.style.display='flex'; setupMessage.style.display='none'; donorNameDisplay.textContent='Esperando donación...'; }
        else{ gameUI.style.display='none'; setupMessage.style.display='block'; }
        showScreen('play');
        document.getElementById('spinBtn').style.display='none';
        buttons.backToHomeFromPlayBtn.style.display='none';
      }

      connectWebSocket();
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
