<!doctype html>
<html>
<head>
Â  <meta charset="utf-8" />
Â  <title>Overlay Ruleta TikTok</title>
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: rgba(0,0,0,.25);
Â  Â  Â  --pill: rgba(0,0,0,.55);
Â  Â  Â  --accent: #ffd54f;
Â  Â  Â  --dur: 15000ms;
Â  Â  }
Â  Â  html,body { height:100%; }
Â  Â  body {
Â  Â  Â  margin:0; font-family: system-ui, Segoe UI, Roboto, Arial;
Â  Â  Â  background: var(--bg); color:#fff; overflow:hidden;
Â  Â  }

Â  Â  /* ===== Topbar (ocÃºltalo si no lo necesitas) ===== */
Â  Â  #topbar {
Â  Â  Â  position: absolute; inset: 12px 12px auto 12px;
Â  Â  Â  display:flex; gap:10px; align-items:center;
Â  Â  Â  z-index: 100;
Â  Â  }
Â  Â  .pill {
Â  Â  Â  padding: 8px 12px; border-radius: 12px; background: var(--pill);
Â  Â  Â  backdrop-filter: blur(6px); font-weight:600;
Â  Â  }
Â  Â  #status.ok { background: rgba(0,120,60,.6); }
Â  Â  #status.err { background: rgba(140,0,0,.6); }
Â  Â  #btn { pointer-events:auto; }

Â  Â  /* ===== Overlay contenedor (show/hide real) ===== */
Â  Â  #overlay {
Â  Â  Â  position:absolute; inset:0;
Â  Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  Â  pointer-events:none;
Â  Â  Â  opacity: 0; transform: scale(.95);
Â  Â  Â  transition: opacity .35s ease, transform .35s ease;
Â  Â  }
Â  Â  #overlay.visible { opacity: 1; transform: scale(1); }
Â  Â  #overlay.hiddenÂ  { display: none; } /* oculto real para OBS/Live Studio */

Â  Â  #viewport {
Â  Â  Â  width:900px; max-width:95vw; height:180px;
Â  Â  Â  border-radius:16px; position:relative; overflow:hidden;
Â  Â  Â  background:rgba(20,20,20,.55);
Â  Â  Â  outline:2px solid rgba(255,255,255,.08);
Â  Â  Â  box-shadow:0 8px 24px rgba(0,0,0,.35);
Â  Â  }
Â  Â  #carril {
Â  Â  Â  display:flex; gap:12px; padding:0 24px;
Â  Â  Â  transform:translateX(0);
Â  Â  }
Â  Â  #carril.anim {
Â  Â  Â  transition: transform var(--dur) cubic-bezier(.12,.65,.22,1);
Â  Â  }

Â  Â  /* Slots cuadrados con auto-ajuste al texto */
Â  Â  .item {
Â  Â  Â  display:inline-flex; align-items:center; justify-content:center;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  aspect-ratio: 1 / 1;Â  Â  /* cuadrado */
Â  Â  Â  min-width: 110px;Â  Â  Â  Â /* crece segÃºn texto; alto = ancho */
Â  Â  Â  height: auto;Â  Â  Â  Â  Â  Â /* lo gobierna el aspect-ratio */
Â  Â  Â  border-radius:12px;
Â  Â  Â  font-size:20px; font-weight:800; text-align:center;
Â  Â  Â  border:1px solid rgba(255,255,255,.12);
Â  Â  Â  user-select:none;
Â  Â  Â  line-height:1.1;
Â  Â  }
Â  Â  .item.nada { background:rgba(207,25,25,.7); }
Â  Â  .item.casi { background:rgba(224,219,56,.7); color:#000; }
Â  Â  .item.winÂ  { background:rgba(16,203,66,.75); }

Â  Â  #marker {
Â  Â  Â  position:absolute; inset:0; pointer-events:none; z-index:5;
Â  Â  }
Â  Â  #marker::after {
Â  Â  Â  content:""; position:absolute; top:-6px; left:50%;
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  width:0; height:0;
Â  Â  Â  border-left:12px solid transparent;
Â  Â  Â  border-right:12px solid transparent;
Â  Â  Â  border-top:16px solid var(--accent);
Â  Â  Â  filter:drop-shadow(0 2px 4px rgba(0,0,0,.4));
Â  Â  }

Â  Â  #toast {
Â  Â  Â  position:absolute; bottom:20px; left:50%;
Â  Â  Â  transform:translateX(-50%) translateY(50px);
Â  Â  Â  background:rgba(0,0,0,.75);
Â  Â  Â  padding:10px 16px; border-radius:10px; opacity:0;
Â  Â  Â  transition:transform .35s ease, opacity .35s ease;
Â  Â  Â  font-weight:700;
Â  Â  }
Â  Â  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

Â  Â  /* Badge (encima del viewport, bajo la flecha) */
Â  Â  #gifterBadge {
Â  Â  Â  position:absolute;
Â  Â  Â  left:50%;
Â  Â  Â  top:calc(50% - 180px/2 - 24px);
Â  Â  Â  transform:translateX(-50%);
Â  Â  Â  background:rgba(0,0,0,.8);
Â  Â  Â  padding:6px 12px; border-radius:10px;
Â  Â  Â  font-weight:800; font-size:14px;
Â  Â  Â  white-space:nowrap;
Â  Â  Â  opacity:0;
Â  Â  Â  transition:opacity .3s ease, transform .3s ease;
Â  Â  Â  pointer-events:none;
Â  Â  Â  z-index:20;
Â  Â  }
Â  Â  #gifterBadge.show { opacity:1; transform:translateX(-50%) translateY(-4px); }
Â  </style>
</head>
<body>
Â  <div id="topbar">
Â  Â  <div id="status" class="pill">WS: conectandoâ€¦</div>
Â  Â  <button id="btn" class="pill">Girar (prueba)</button>
Â  </div>

Â  Â  <div id="overlay" class="hidden">
Â  Â  <div id="gifterBadge"></div>

Â  Â  <div id="viewport">
Â  Â  Â  <div id="marker"></div>
Â  Â  Â  <div id="carril">
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item win">WIN</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
        <div class="item casi">Casi</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  Â  <div class="item nada">Nada</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="toast">Premio: â€”</div>
Â  </div>

<script>
Â  // ===== CONFIG =====
Â  const PROBABILIDADES={nada:1.0,casi:0,win:0}; // edita a gusto
Â  const BASE_MS=15000, MS_POR_SLOT=0, COPIAS=15;
Â  const CENTER_NUDGE_PX = 0;

Â  // Reglas de conversiÃ³n a giros
Â  const COINS_PER_SPIN = 1;Â  Â  Â  Â  Â  // 1 giro por N coins
Â  const COUNT_PER_SPIN = 0;Â  Â  Â  Â  Â  // 0 si ya usas coins (evita doble conteo)
Â  const ONLY_ON_STREAK_END = true;Â  Â // contar sÃ³lo al finalizar la racha

Â  // ApariciÃ³n/desapariciÃ³n
Â  const AUTOHIDE_DELAY_MS = 1200;Â  Â  // tras el Ãºltimo giro
Â  const INACTIVITY_TIMEOUT_MS = 5000;// si se mostrÃ³ pero no arrancÃ³

Â  const GIFT_VALUES = { "rose":1, "rosa":1, "la rosa":1 };

Â  // ===== Estado =====
Â  let ws=null, spinning=false;
Â  let pendingSpins=0;
Â  let spinQueue=[];
Â  const statusEl=document.getElementById('status');
Â  const btn=document.getElementById('btn');
Â  const overlay=document.getElementById('overlay');
Â  const viewport=document.getElementById('viewport');
Â  const carril=document.getElementById('carril');
Â  const toast=document.getElementById('toast');
Â  const gifterBadge=document.getElementById('gifterBadge');
Â  let baseCount=0,middleBlock=0,currentAbs=0,ITEM_W=150,STEP_W=162;
Â  let hideBadgeTimer=null, hideOverlayTimer=null, inactivityTimer=null;
Â  let CURRENT_TX = 0;

Â  // ===== Mostrar/ocultar overlay =====
Â  function showOverlay() {
Â  Â  if (hideOverlayTimer) { clearTimeout(hideOverlayTimer); hideOverlayTimer = null; }
Â  Â  if (inactivityTimer)Â  Â { clearTimeout(inactivityTimer); inactivityTimer = null; }
Â  Â  overlay.classList.remove('hidden');Â  Â  Â  Â // Quita display:none para que la transiciÃ³n funcione
Â  Â  overlay.getBoundingClientRect();Â  Â  Â  Â  Â  // Reflow
Â  Â  overlay.classList.add('visible');Â  Â  Â  Â  Â // Inicia la animaciÃ³n de entrada
Â  }
Â  function hideOverlayLater(ms = AUTOHIDE_DELAY_MS) {
Â  Â  if (hideOverlayTimer) clearTimeout(hideOverlayTimer);
Â  Â  hideOverlayTimer = setTimeout(() => {
Â  Â  Â  if (!spinning && pendingSpins === 0) {
Â  Â  Â  Â  overlay.classList.remove('visible'); // Inicia la animaciÃ³n de salida
Â  Â  Â  }
Â  Â  }, ms);
Â  }
Â  // Cuando termina el fade-out, ocultar de verdad (agrega la clase 'hidden')
Â  overlay.addEventListener('transitionend', (ev) => {
Â  Â  if (ev.target !== overlay) return;
Â  Â  if (!overlay.classList.contains('visible')) {
Â  Â  Â  overlay.classList.add('hidden');Â  Â  Â  Â  // AÃ±ade display:none para ocultarlo completamente
Â  Â  }
Â  });

Â  function armInactivityAutoHide() {
Â  Â  if (inactivityTimer) clearTimeout(inactivityTimer);
Â  Â  inactivityTimer = setTimeout(() => {
Â  Â  Â  if (!spinning && pendingSpins === 0) {
Â  Â  Â  Â  overlay.classList.remove('visible'); // Inicia el fade-out
Â  Â  Â  }
Â  Â  }, INACTIVITY_TIMEOUT_MS);
Â  }
Â  function cancelInactivityAutoHide() {
Â  Â  if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
Â  }

Â  // ===== Utilidades de layout =====
Â  function measureSizes(){
Â  Â  const prev=carril.style.transform;
Â  Â  carril.classList.remove('anim'); carril.style.transform='translateX(0px)';
Â  Â  const items=carril.querySelectorAll('.item');
Â  Â  if(items.length>=2){
Â  Â  Â  const r1=items[0].getBoundingClientRect();
Â  Â  Â  const r2=items[1].getBoundingClientRect();
Â  Â  Â  ITEM_W=r1.width; STEP_W=r2.left-r1.left;
Â  Â  }
Â  Â  requestAnimationFrame(()=>{ carril.style.transform=prev||'translateX(0px)'; });
Â  }
Â  function setTransform(tx, smooth=false, durMs=BASE_MS){
Â  Â  if(smooth){
Â  Â  Â  carril.style.setProperty('--dur', `${Math.max(50, Math.round(durMs))}ms`);
Â  Â  Â  carril.classList.add('anim');
Â  Â  } else {
Â  Â  Â  carril.classList.remove('anim');
Â  Â  }
Â  Â  CURRENT_TX = tx;
Â  Â  carril.style.transform = `translateX(${tx}px)`;
Â  }
Â  function renderTo(absIndex,smooth=true,durMs=BASE_MS){
Â  Â  const rect=viewport.getBoundingClientRect();
Â  Â  const center=(rect.width/2)-(ITEM_W/2);
Â  Â  const tx=-(absIndex*STEP_W)+center;
Â  Â  setTransform(tx, smooth, durMs);
Â  Â  currentAbs=absIndex;
Â  }
Â  function mod(n,m){return((n%m)+m)%m;}
Â  function recenter(absIndex){
Â  Â  const rel=mod(absIndex,baseCount);
Â  Â  renderTo(middleBlock*baseCount+rel,false);
Â  }

Â  // ===== Probabilidades =====
Â  function getWeightedRandomIndex() {
Â  Â  const items = carril.querySelectorAll('.item');
Â  Â  const buckets = { nada: [], casi: [], win: [] };
Â  Â  for (let i = 0; i < baseCount; i++) {
Â  Â  Â  const cls = items[i].classList;
Â  Â  Â  const tipo = cls.contains('win') ? 'win' : (cls.contains('casi') ? 'casi' : 'nada');
Â  Â  Â  buckets[tipo].push(i);
Â  Â  }
Â  Â  const ORDER = ['nada','casi','win'];
Â  Â  const weights = {}; let sum = 0;
Â  Â  for (const k of ORDER) {
Â  Â  Â  let w = Math.max(0, Number(PROBABILIDADES[k] ?? 0));
Â  Â  Â  if (!buckets[k].length) w = 0;
Â  Â  Â  weights[k] = w; sum += w;
Â  Â  }
Â  Â  if (sum <= 0) {
Â  Â  Â  for (const k of ORDER) if (buckets[k].length) {
Â  Â  Â  Â  const b=buckets[k]; return b[Math.floor(Math.random()*b.length)];
Â  Â  Â  }
Â  Â  Â  return 0;
Â  Â  }
Â  Â  const r=Math.random(); let acc=0;
Â  Â  for (const k of ORDER) {
Â  Â  Â  acc += weights[k]/sum;
Â  Â  Â  if (r < acc && buckets[k].length) {
Â  Â  Â  Â  const b=buckets[k]; return b[Math.floor(Math.random()*b.length)];
Â  Â  Â  }
Â  Â  }
Â  Â  for (let i=ORDER.length-1;i>=0;i--){
Â  Â  Â  const b=buckets[ORDER[i]]; if (b.length) return b[Math.floor(Math.random()*b.length)];
Â  Â  }
Â  Â  return 0;
Â  }

Â  // ===== UI helpers =====
Â  function showToast(txt,ms=1200){ toast.textContent=txt; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),ms); }
Â  function showBadge(txt){ if(hideBadgeTimer) clearTimeout(hideBadgeTimer); gifterBadge.textContent=`ðŸŽ ${txt}`; gifterBadge.classList.add('show'); }
Â  function hideBadgeLater(ms=800){ if(hideBadgeTimer) clearTimeout(hideBadgeTimer); hideBadgeTimer=setTimeout(()=>gifterBadge.classList.remove('show'),ms); }

Â  function getItemUnderMarker(){
Â  Â  const rect = viewport.getBoundingClientRect();
Â  Â  const x = rect.left + rect.width/2 + CENTER_NUDGE_PX;
Â  Â  const y = rect.top + 8;
Â  Â  let el = document.elementFromPoint(x, y);
Â  Â  while (el && !el.classList?.contains('item')) el = el.parentElement;
Â  Â  return el || null;
Â  }
Â  function snapCenterOnElement(el){
Â  Â  if(!el) return;
Â  Â  const vp = viewport.getBoundingClientRect();
Â  Â  const er = el.getBoundingClientRect();
Â  Â  const delta = (er.left + er.width/2) - (vp.left + vp.width/2);
Â  Â  setTransform(CURRENT_TX - delta, false);
Â  }

Â  // ===== Giro =====
Â  function spinOnce(){
Â  Â  if(spinning){return;}
Â  Â  spinning=true;

Â  Â  cancelInactivityAutoHide();
Â  Â  showOverlay();

Â  Â  const currentSpinner = spinQueue.shift() || 'AnÃ³nimo';
Â  Â  pendingSpins = Math.max(0, pendingSpins - 1);
Â  Â  showBadge(currentSpinner);

Â  Â  const idxRel=getWeightedRandomIndex();
Â  Â  const vueltas=2+Math.floor(Math.random()*2);
Â  Â  const pasos=vueltas*baseCount+idxRel;
Â  Â  const durMs=BASE_MS+pasos*MS_POR_SLOT;
Â  Â  const targetAbs=currentAbs+pasos;

Â  Â  renderTo(targetAbs,true,durMs);

Â  Â  const onEnd=()=>{
Â  Â  Â  carril.removeEventListener('transitionend',onEnd);
Â  Â  Â  recenter(targetAbs);
Â  Â  Â  const elCentro = getItemUnderMarker();
Â  Â  Â  snapCenterOnElement(elCentro);
Â  Â  Â  const premio = elCentro ? elCentro.innerText.trim().replace(/\s+/g,' ') : '(?)';
Â  Â  Â  showToast('Premio: '+premio);
Â  Â  Â  hideBadgeLater(600);

Â  Â  Â  spinning=false;
Â  Â  Â  if (pendingSpins > 0) {
Â  Â  Â  Â  setTimeout(spinOnce, 300);
Â  Â  Â  } else {
Â  Â  Â  Â  hideOverlayLater(AUTOHIDE_DELAY_MS);
Â  Â  Â  }
Â  Â  };
Â  Â  carril.addEventListener('transitionend',onEnd,{once:true});
Â  }

Â  // ===== Cola de giros =====
Â  function queueSpins(n, user){
Â  Â  n = Math.max(0, Math.floor(n||0));
Â  Â  if (!n) return;
Â  Â  const name = user || 'AnÃ³nimo';
Â  Â  for (let i=0;i<n;i++) spinQueue.push(name);
Â  Â  pendingSpins += n;

Â  Â  showOverlay();
Â  Â  if (!spinning) {
Â  Â  Â  // Si por alguna razÃ³n no inicia, ocÃºltalo por inactividad
Â  Â  Â  armInactivityAutoHide();
Â  Â  Â  spinOnce();
Â  Â  }
Â  }

Â  // ===== Gifts â†’ giros =====
Â  function inferCoinsFromName(name, count=1) {
Â  Â  if (!name) return 0;
Â  Â  const key = String(name).toLowerCase();
Â  Â  const per = GIFT_VALUES[key] || 0;
Â  Â  return per * Math.max(1, count);
Â  }
Â  function spinsFromGift(msg){
Â  Â  const name = (msg.gift ?? msg.gift_name ?? msg.giftName ?? "").toString();
Â  Â  const count = Number(
Â  Â  Â  msg.count ?? msg.repeat_count ?? msg.repeatCount ??
Â  Â  Â  msg.quantity ?? msg.combo_count ?? 0
Â  Â  );
Â  Â  let coins = Number(
Â  Â  Â  msg.coins ?? msg.diamonds ?? msg.coin ?? msg.value ?? NaN
Â  Â  );
Â  Â  if (!isFinite(coins) || coins < 0) coins = NaN;

Â  Â  const hasStreakFlag = (
Â  Â  Â  'streak_end' in msg || 'streakEnd' in msg ||
Â  Â  Â  'repeat_end' in msg || 'repeatEnd' in msg ||
Â  Â  Â  'combo_end'Â  in msg || 'comboEnd' in msg ||
Â  Â  Â  'is_completed' in msg || 'isCompleted' in msg
Â  Â  );
Â  Â  const isStreakEnd = Boolean(
Â  Â  Â  msg.streak_end ?? msg.streakEnd ?? msg.repeat_end ?? msg.repeatEnd ??
Â  Â  Â  msg.combo_endÂ  ?? msg.comboEndÂ  ?? msg.is_completed ?? msg.isCompleted ?? false
Â  Â  );
Â  Â  if (ONLY_ON_STREAK_END && hasStreakFlag && !isStreakEnd) return 0;

Â  Â  let spins = 0;
Â  Â  if (isFinite(coins)) {
Â  Â  Â  spins = Math.floor(coins / COINS_PER_SPIN);
Â  Â  } else {
Â  Â  Â  const inferred = inferCoinsFromName(name, Math.max(1, count || 1));
Â  Â  Â  if (inferred > 0) {
Â  Â  Â  Â  spins = Math.floor(inferred / COINS_PER_SPIN);
Â  Â  Â  } else if (COUNT_PER_SPIN > 0 && count > 0) {
Â  Â  Â  Â  spins = count * COUNT_PER_SPIN;
Â  Â  Â  }
Â  Â  }
Â  Â  return Math.max(0, Math.floor(spins || 0));
Â  }

Â  // ===== Init =====
Â  (function init(){
Â  Â  const baseHTML=carril.innerHTML;
Â  Â  baseCount=carril.children.length;
Â  Â  for(let i=1;i<COPIAS;i++) carril.insertAdjacentHTML('beforeend',baseHTML);
Â  Â  middleBlock=Math.floor(COPIAS/2);
Â  Â  measureSizes();
Â  Â  currentAbs=middleBlock*baseCount+Math.floor(baseCount/2);
Â  Â  renderTo(currentAbs,false);

Â  Â  // AsegÃºrate de que el overlay estÃ© oculto al iniciar
Â  Â  overlay.classList.remove('visible');
Â  Â  overlay.classList.add('hidden');

Â  Â  window.addEventListener('resize',()=>{measureSizes();renderTo(currentAbs,false);});
Â  })();

Â  // BotÃ³n de prueba (exactamente 1 giro)
Â  btn.addEventListener('click', () => {
Â  Â  if (spinning || pendingSpins > 0) return;
Â  Â  queueSpins(1, 'Tester');
Â  });

Â  // ===== WebSocket =====
Â  function openWS(){
Â  Â  try{ws=new WebSocket('ws://127.0.0.1:8765');} // ajusta a tu host/tÃºnel
Â  Â  catch(e){statusEl.textContent='WS: error URL';statusEl.classList.add('err');return;}
Â  Â  ws.onopen=()=>{statusEl.textContent='WS: conectado';statusEl.classList.add('ok');};
Â  Â  ws.onclose=()=>{statusEl.textContent='WS: desconectado';statusEl.classList.remove('ok');setTimeout(openWS,1000);};
Â  Â  ws.onerror=()=>{statusEl.textContent='WS: error';statusEl.classList.add('err');};
Â  Â  ws.onmessage=ev=>{
Â  Â  Â  try{
Â  Â  Â  Â  const msg=JSON.parse(ev.data);
Â  Â  Â  Â  if(msg.type==='gift'){
Â  Â  Â  Â  Â  const spins = spinsFromGift(msg);
Â  Â  Â  Â  Â  if (spins > 0) queueSpins(spins, msg.user);
Â  Â  Â  Â  }
Â  Â  Â  }catch{}
Â  Â  };
Â  }
Â  openWS();
</script>
</body>
</html>
